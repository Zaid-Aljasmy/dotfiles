#!/bin/bash


battery_path="/sys/class/power_supply/BAT0"
if [[ ! -d "$battery_path" ]]; then
    battery_path="/sys/class/power_supply/BAT1"
fi

if [[ ! -d "$battery_path" ]]; then
    echo "Battery not found"
    exit 1
fi

if [[ -f "$battery_path/status" ]] && [[ -f "$battery_path/capacity" ]]; then
    status=$(cat "$battery_path/status")
    capacity=$(cat "$battery_path/capacity")
else
    echo "Battery files not found"
    exit 1
fi

status_lower=$(echo "$status" | tr '[:upper:]' '[:lower:]')

power_profile=""
if [[ "$status_lower" == "charging" ]]; then
    power_profile="performance"
elif [[ "$capacity" -le 20 && "$status_lower" == "discharging" ]]; then
    power_profile="power-saver"
else

    power_profile="balanced"
fi

if command -v powerprofilesctl &> /dev/null; then
    current_profile=$(powerprofilesctl get 2>/dev/null)
    if [[ "$current_profile" != "$power_profile" ]]; then
        powerprofilesctl set "$power_profile" &> /dev/null
    fi
fi

label=""
if [[ "$status_lower" == "charging" ]]; then
    label=" chr"
elif [[ "$status_lower" == "full" || "$status_lower" == "not charging" ]]; then
    label=" full"
elif [[ "$capacity" -le 20 && "$status_lower" == "discharging" ]]; then
    label=" low"
fi

color="#d3c6aa"

echo "<span foreground='$color'>Bat</span> $capacity%$label"
